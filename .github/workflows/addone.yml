name: PR Automation with Docker, Tests, Slack, and Approval

on:
  pull_request:
    types: [opened, synchronize, closed]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Build Docker Image
      run: docker build -t sample-nodejs-app .

    - name: Run Tests
      run: docker run --rm sample-nodejs-app npm test

    - name: Notify Slack - Test Passed
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text": "Build & Test Passed on PR #${{ github.event.number }}: Ready for Approval."}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack - Test Failed
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text": "Build & Test Failed on PR #${{ github.event.number }}: Check logs for more info."}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

  approval:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Request Approval
      uses: ridedott/merge-me-action@v2
      with:
        github-token: ${{ secrets.DGITHUB_TOKEN }}
        pull-request-number: ${{ github.event.number }}

    - name: Notify Slack - Approval Required
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text": "PR #${{ github.event.number }}: Ready for Review. Please approve or reject."}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

  merge:
    runs-on: ubuntu-latest
    needs: approval
    if: github.event.pull_request.merged == 'false' && success()

    steps:
    - name: Merge Pull Request
      run: |
        gh pr merge ${{ github.event.pull_request.number }} --merge
